<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة العملاء - MicroSystem</title>
    <style>
        :root {
            --background: hsl(0, 0%, 93%);
            --foreground: hsl(0, 0%, 26%);
            --card: hsl(0, 0%, 96%);
            --card-foreground: hsl(0, 0%, 26%);
            --primary: hsl(0, 0%, 26%);
            --primary-foreground: hsl(0, 0%, 98%);
            --secondary: hsl(0, 0%, 96%);
            --secondary-foreground: hsl(0, 0%, 26%);
            --muted: hsl(0, 0%, 96%);
            --muted-foreground: hsl(0, 0%, 46%);
            --accent: hsl(0, 0%, 96%);
            --accent-foreground: hsl(0, 0%, 26%);
            --destructive: hsl(0, 0%, 40%);
            --destructive-foreground: hsl(0, 0%, 98%);
            --border: hsl(0, 0%, 92%);
            --input: hsl(0, 0%, 92%);
            --ring: hsl(0, 0%, 63.9%);
            --radius: 1.5rem;
            --success: hsl(0, 0%, 30%);
            --success-foreground: hsl(0, 0%, 98%);
            --warning: hsl(0, 0%, 35%);
            --warning-foreground: hsl(0, 0%, 98%);
            --info: hsl(0, 0%, 32%);
            --info-foreground: hsl(0, 0%, 98%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: var(--card);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            color: var(--primary);
            font-size: 2em;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--primary-foreground);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            opacity: 0.9;
        }

        .btn-secondary {
            background: var(--secondary);
            color: var(--secondary-foreground);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--muted);
        }

        .btn-success {
            background: var(--success);
            color: var(--success-foreground);
        }

        .btn-success:hover {
            opacity: 0.9;
        }

        .btn-warning {
            background: var(--warning);
            color: var(--warning-foreground);
        }

        .btn-warning:hover {
            opacity: 0.9;
        }

        .btn-danger {
            background: var(--destructive);
            color: var(--destructive-foreground);
        }

        .btn-danger:hover {
            opacity: 0.9;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 20px;
            border: 1px solid var(--border);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .stat-info h3 {
            color: var(--muted-foreground);
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .stat-info p {
            color: var(--foreground);
            font-size: 28px;
            font-weight: 700;
        }

        .search-filter {
            background: var(--card);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border);
        }

        .search-box {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 12px 20px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            background: var(--card);
            color: var(--foreground);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px hsla(0, 0%, 26%, 0.1);
        }

        .filter-select {
            padding: 12px 20px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            background: var(--card);
            color: var(--foreground);
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .tenants-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
        }

        .tenant-card {
            background: var(--card);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .tenant-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .tenant-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: var(--primary);
        }

        .tenant-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .tenant-logo {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-foreground);
            font-size: 24px;
            font-weight: bold;
        }

        .tenant-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }

        .tenant-info h3 {
            color: var(--foreground);
            font-size: 18px;
            margin-bottom: 5px;
        }

        .tenant-info p {
            color: var(--muted-foreground);
            font-size: 14px;
        }

        .tenant-status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .status-active {
            background: hsl(0, 0%, 88%);
            color: hsl(0, 0%, 26%);
        }

        .status-inactive {
            background: hsl(0, 0%, 85%);
            color: hsl(0, 0%, 30%);
        }

        .tenant-details {
            margin-bottom: 20px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: var(--muted-foreground);
            font-size: 14px;
        }

        .detail-value {
            color: var(--foreground);
            font-weight: 600;
            font-size: 14px;
        }

        .tenant-modules {
            margin-bottom: 20px;
        }

        .modules-title {
            color: var(--foreground);
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .modules-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .module-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            background: var(--muted);
            color: var(--muted-foreground);
            border: 1px solid var(--border);
        }

        .module-badge.enabled {
            background: hsl(0, 0%, 88%);
            color: hsl(0, 0%, 26%);
            border-color: hsl(0, 0%, 82%);
        }

        .tenant-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: var(--foreground);
            font-size: 18px;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 15px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: hsl(0, 0%, 88%);
            color: hsl(0, 0%, 26%);
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid var(--destructive);
        }

        .success-message {
            background: hsl(0, 0%, 90%);
            color: hsl(0, 0%, 26%);
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid var(--success);
        }

        .empty-state {
            background: var(--card);
            border-radius: 15px;
            padding: 60px 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border);
        }

        .empty-state-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
            color: var(--muted-foreground);
        }

        .empty-state h3 {
            color: var(--foreground);
            font-size: 24px;
            margin-bottom: 10px;
        }

        .empty-state p {
            color: var(--muted-foreground);
            font-size: 16px;
            margin-bottom: 30px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--card);
            border-radius: 15px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            animation: modalSlide 0.3s ease-out;
            border: 1px solid var(--border);
        }

        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .modal-header h2 {
            color: var(--foreground);
            font-size: 24px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--muted-foreground);
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: var(--destructive);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: var(--foreground);
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
            background: var(--card);
            color: var(--foreground);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px hsla(0, 0%, 26%, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .color-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .color-input-group input[type="color"] {
            width: 60px;
            height: 45px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .color-input-group input[type="text"] {
            flex: 1;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid var(--border);
        }

        .modules-section {
            margin: 25px 0;
            padding: 20px;
            background: var(--muted);
            border-radius: 10px;
            border: 2px solid var(--border);
        }

        .modules-section h3 {
            color: var(--foreground);
            font-size: 16px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .module-item {
            background: var(--card);
            padding: 12px;
            border-radius: 8px;
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .module-item:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .module-item.enabled {
            background: hsl(0, 0%, 90%);
            border-color: var(--success);
        }

        .module-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .module-label {
            flex: 1;
            font-size: 14px;
            color: var(--foreground);
            cursor: pointer;
            user-select: none;
        }

        .module-item.enabled .module-label {
            font-weight: 600;
            color: hsl(0, 0%, 26%);
        }

        /* Modern Multi-Select Styles for Edit Modal */
        .multi-select-wrapper-edit {
            position: relative;
            width: 100%;
        }

        .multi-select-header-edit {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 48px;
        }

        .multi-select-header-edit:hover {
            border-color: var(--primary);
            background: var(--muted);
        }

        .multi-select-header-edit.active {
            border-color: var(--primary);
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }

        .multi-select-header-edit.active svg {
            transform: rotate(180deg);
        }

        .multi-select-dropdown-edit {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card);
            border: 2px solid var(--primary);
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            z-index: 1000;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .multi-select-dropdown-edit.show {
            max-height: 350px;
            overflow-y: auto;
        }

        .selected-tenants-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .tenant-tag {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--primary);
            color: var(--primary-foreground);
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            animation: tagSlideIn 0.3s ease;
        }

        @keyframes tagSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tenant-tag .remove-tag {
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .tenant-tag .remove-tag:hover {
            opacity: 1;
        }

        /* Shared styles for multi-select options */
        .multi-select-search {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            background: var(--card);
            z-index: 1;
        }

        .multi-select-search input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s;
        }

        .multi-select-search input:focus {
            border-color: var(--primary);
            background: var(--muted);
        }

        .multi-select-options {
            max-height: 280px;
            overflow-y: auto;
        }

        .multi-select-option {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid var(--border);
        }

        .multi-select-option:last-child {
            border-bottom: none;
        }

        .multi-select-option:hover {
            background: var(--muted);
        }

        .multi-select-option input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-left: 12px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: stretch;
            }

            .header-actions {
                justify-content: stretch;
            }

            .header-actions .btn {
                flex: 1;
                justify-content: center;
            }

            .tenants-grid {
                grid-template-columns: 1fr;
            }

            .search-box {
                flex-direction: column;
            }

            .search-input,
            .filter-select {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                إدارة العملاء (Tenants)
            </h1>
            <div class="header-actions">
                <a href="/api/create-tenant/" class="btn btn-primary">
                    إضافة عميل جديد
                </a>
                <button class="btn btn-secondary" onclick="refreshData()">
                    تحديث
                </button>
                <a href="/admin/" class="btn btn-secondary">
                    لوحة التحكم
                </a>
            </div>
        </div>

        <!-- Statistics -->
        <!-- <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    📊
                </div>
                <div class="stat-info">
                    <h3>إجمالي العملاء</h3>
                    <p id="totalTenants">-</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                    ✅
                </div>
                <div class="stat-info">
                    <h3>العملاء النشطين</h3>
                    <p id="activeTenants">-</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                    ❌
                </div>
                <div class="stat-info">
                    <h3>العملاء المعطلين</h3>
                    <p id="inactiveTenants">-</p>
                </div>
            </div>
        </div> -->

        <!-- Search and Filter -->
        <div class="search-filter">
            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="ابحث عن عميل..." onkeyup="filterTenants()">
                <select class="filter-select" id="statusFilter" onchange="filterTenants()">
                    <option value="all">جميع الحالات</option>
                    <option value="active">نشط فقط</option>
                    <option value="inactive">معطل فقط</option>
                </select>
            </div>
        </div>

        <!-- Messages -->
        <div id="messageContainer"></div>

        <!-- Loading -->
        <div id="loading" class="loading">جاري تحميل البيانات...</div>

        <!-- Tenants Grid -->
        <div id="tenantsGrid" class="tenants-grid" style="display: none;"></div>

        <!-- Empty State -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="empty-state-icon"></div>
            <h3>لا يوجد عملاء</h3>
            <p>ابدأ بإضافة عميل جديد للنظام</p>
            <a href="/api/create-tenant/" class="btn btn-primary">إضافة عميل جديد</a>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>تعديل بيانات العميل</h2>
                <button class="close-modal" onclick="closeEditModal()">×</button>
            </div>
            <form id="editForm" onsubmit="updateTenant(event)">
                <input type="hidden" id="editTenantId">
                
                <div class="form-group">
                    <label>اسم العميل *</label>
                    <input type="text" id="editName" required>
                </div>

                <div class="form-group">
                    <label>Subdomain *</label>
                    <input type="text" id="editSubdomain" required readonly title="لا يمكن تعديل الـ Subdomain">
                </div>

                <div class="form-group">
                    <label>Custom Domain (اختياري)</label>
                    <input type="text" id="editCustomDomain" placeholder="client.myapp.com">
                </div>

                <div class="form-group">
                    <label>البريد الإلكتروني</label>
                    <input type="email" id="editEmail">
                </div>

                <div class="form-group">
                    <label>رقم الهاتف</label>
                    <input type="tel" id="editPhone">
                </div>

                <div class="form-group">
                    <label>اللون الأساسي</label>
                    <div class="color-input-group">
                        <input type="color" id="editPrimaryColor" value="#424242">
                        <input type="text" id="editPrimaryColorText" value="#424242" pattern="^#[0-9A-Fa-f]{6}$">
                    </div>
                </div>

                <div class="form-group">
                    <label>اللون الثانوي</label>
                    <div class="color-input-group">
                        <input type="color" id="editSecondaryColor" value="#f5f5f5">
                        <input type="text" id="editSecondaryColorText" value="#f5f5f5" pattern="^#[0-9A-Fa-f]{6}$">
                    </div>
                </div>

                <div class="form-group">
                    <label>الحالة</label>
                    <select id="editIsActive">
                        <option value="true">نشط</option>
                        <option value="false">معطل</option>
                    </select>
                </div>

                <!-- Modules Section -->
                <div class="modules-section">
                    <h3>
                        الموديولات المتاحة
                    </h3>
                    <div id="modulesGrid" class="modules-grid">
                        <div style="grid-column: 1 / -1; text-align: center; color: var(--muted-foreground);">
                            جاري تحميل الموديولات...
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">إلغاء</button>
                    <button type="submit" class="btn btn-success">حفظ التغييرات</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>تأكيد الحذف</h2>
                <button class="close-modal" onclick="closeDeleteModal()">×</button>
            </div>
            <p style="margin: 20px 0; font-size: 16px; color: var(--foreground);">
                هل أنت متأكد من حذف العميل <strong id="deleteTenantName"></strong>؟
            </p>
            <p style="margin: 20px 0; font-size: 14px; color: var(--destructive); font-weight: 600;">
                تحذير: هذا الإجراء لا يمكن التراجع عنه!
            </p>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">إلغاء</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">حذف نهائياً</button>
            </div>
        </div>
    </div>

    <script>
        let allTenants = [];
        let currentDeleteId = null;
        let tenantModules = {}; // Store tenant modules
        let currentEditingTenantId = null;

        // Load data on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadTenants();
            loadStatistics();
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(event) {
                const wrapperEdit = document.querySelector('.multi-select-wrapper-edit');
                const dropdownEdit = document.getElementById('multiSelectDropdownEdit');
                const headerEdit = document.querySelector('.multi-select-header-edit');
                
                if (wrapperEdit && !wrapperEdit.contains(event.target)) {
                    if (dropdownEdit) dropdownEdit.classList.remove('show');
                    if (headerEdit) headerEdit.classList.remove('active');
                }
            });
            
            // Sync color inputs
            document.getElementById('editPrimaryColor').addEventListener('input', (e) => {
                document.getElementById('editPrimaryColorText').value = e.target.value;
            });
            document.getElementById('editPrimaryColorText').addEventListener('input', (e) => {
                document.getElementById('editPrimaryColor').value = e.target.value;
            });
            document.getElementById('editSecondaryColor').addEventListener('input', (e) => {
                document.getElementById('editSecondaryColorText').value = e.target.value;
            });
            document.getElementById('editSecondaryColorText').addEventListener('input', (e) => {
                document.getElementById('editSecondaryColor').value = e.target.value;
            });
        });

        async function loadTenants() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('tenantsGrid').style.display = 'none';
                document.getElementById('emptyState').style.display = 'none';

                const response = await fetch('/api/tenants/', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                allTenants = data;
                displayTenants(data);
            } catch (error) {
                console.error('Error loading tenants:', error);
                showMessage('حدث خطأ أثناء تحميل البيانات', 'error');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function loadStatistics() {
            try {
                const response = await fetch('/api/tenants/statistics/', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                document.getElementById('totalTenants').textContent = data.total_tenants;
                document.getElementById('activeTenants').textContent = data.active_tenants;
                document.getElementById('inactiveTenants').textContent = data.inactive_tenants;
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        function displayTenants(tenants) {
            const grid = document.getElementById('tenantsGrid');
            const emptyState = document.getElementById('emptyState');

            if (tenants.length === 0) {
                grid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            grid.style.display = 'grid';
            emptyState.style.display = 'none';

            grid.innerHTML = tenants.map(tenant => `
                <div class="tenant-card" style="--primary-color: ${tenant.primary_color}; --secondary-color: ${tenant.secondary_color}">
                    <div class="tenant-header">
                        <div class="tenant-logo">
                            ${tenant.logo ? `<img src="${tenant.logo}" alt="${tenant.name}">` : tenant.name.charAt(0)}
                        </div>
                        <div class="tenant-info">
                            <h3>${tenant.name}</h3>
                            <p>${tenant.subdomain}.myapp.com</p>
                        </div>
                    </div>

                    <span class="tenant-status ${tenant.is_active ? 'status-active' : 'status-inactive'}">
                        ${tenant.is_active ? 'نشط' : 'معطل'}
                    </span>

                    <div class="tenant-details">
                        ${tenant.custom_domain ? `
                        <div class="detail-row">
                            <span class="detail-label">النطاق المخصص:</span>
                            <span class="detail-value">${tenant.custom_domain}</span>
                        </div>
                        ` : ''}
                        ${tenant.contact_email ? `
                        <div class="detail-row">
                            <span class="detail-label">البريد الإلكتروني:</span>
                            <span class="detail-value">${tenant.contact_email}</span>
                        </div>
                        ` : ''}
                        ${tenant.contact_phone ? `
                        <div class="detail-row">
                            <span class="detail-label">الهاتف:</span>
                            <span class="detail-value">${tenant.contact_phone}</span>
                        </div>
                        ` : ''}
                        <div class="detail-row">
                            <span class="detail-label">تاريخ الإنشاء:</span>
                            <span class="detail-value">${new Date(tenant.created_at).toLocaleDateString('ar-EG')}</span>
                        </div>
                    </div>

                    <div class="tenant-modules">
                        <div class="modules-title">الموديولات النشطة:</div>
                        <div class="modules-list" id="modules-${tenant.id}">
                            <span class="module-badge">جاري التحميل...</span>
                        </div>
                    </div>

                    <div class="tenant-actions">
                        <button class="btn btn-primary btn-sm" onclick="viewTenant('${tenant.id}')">
                            عرض
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="editTenant('${tenant.id}')">
                            تعديل
                        </button>
                        <button class="btn btn-success btn-sm" onclick="manageModules('${tenant.id}')">
                            الموديولات
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteTenant('${tenant.id}', '${tenant.name}')">
                            حذف
                        </button>
                    </div>
                </div>
            `).join('');

            // Load modules for each tenant
            tenants.forEach(tenant => loadTenantModules(tenant.id));
        }

        async function loadTenantModules(tenantId) {
            try {
                const response = await fetch(`/api/tenants/${tenantId}/modules/`, {
                    credentials: 'include'
                });
                const modules = await response.json();
                
                const enabledModules = modules.filter(m => m.is_enabled);
                const modulesList = document.getElementById(`modules-${tenantId}`);
                
                if (modulesList) {
                    if (enabledModules.length === 0) {
                        modulesList.innerHTML = '<span class="module-badge">لا توجد موديولات مفعلة</span>';
                    } else {
                        modulesList.innerHTML = enabledModules.map(m => 
                            `<span class="module-badge enabled">${m.module_name}</span>`
                        ).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading modules:', error);
            }
        }

        function filterTenants() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;

            const filtered = allTenants.filter(tenant => {
                const matchesSearch = tenant.name.toLowerCase().includes(searchTerm) ||
                                    tenant.subdomain.toLowerCase().includes(searchTerm) ||
                                    (tenant.contact_email && tenant.contact_email.toLowerCase().includes(searchTerm));
                
                const matchesStatus = statusFilter === 'all' || 
                                     (statusFilter === 'active' && tenant.is_active) ||
                                     (statusFilter === 'inactive' && !tenant.is_active);

                return matchesSearch && matchesStatus;
            });

            displayTenants(filtered);
        }

        function viewTenant(id) {
            window.location.href = `/admin/hr_management/tenant/${id}/change/`;
        }

        function editTenant(id) {
            const tenant = allTenants.find(t => t.id === id);
            if (!tenant) return;

            currentEditingTenantId = id;
            
            document.getElementById('editTenantId').value = tenant.id;
            document.getElementById('editName').value = tenant.name;
            document.getElementById('editSubdomain').value = tenant.subdomain;
            document.getElementById('editCustomDomain').value = tenant.custom_domain || '';
            document.getElementById('editEmail').value = tenant.contact_email || '';
            document.getElementById('editPhone').value = tenant.contact_phone || '';
            document.getElementById('editPrimaryColor').value = tenant.primary_color;
            document.getElementById('editPrimaryColorText').value = tenant.primary_color;
            document.getElementById('editSecondaryColor').value = tenant.secondary_color;
            document.getElementById('editSecondaryColorText').value = tenant.secondary_color;
            document.getElementById('editIsActive').value = tenant.is_active.toString();

            // Load tenant modules
            loadEditModules(id);

            document.getElementById('editModal').classList.add('show');
        }

        async function loadRelatedTenantsForEdit(currentTenantId, selectedTenants) {
            console.log('🔵 loadRelatedTenantsForEdit called', {currentTenantId, selectedTenants});
            selectedTenantsEdit.clear();
            
            try {
                const response = await fetch('/api/tenants/', { credentials: 'include' });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('✅ All tenants loaded:', data);
                console.log('✅ Selected tenants:', selectedTenants);
                
                // Handle both paginated and non-paginated responses
                allTenantsForSelection = (data.results || data).filter(t => t.id !== currentTenantId);
                console.log('✅ Filtered tenants (excluding current):', allTenantsForSelection.length);
                
                // Set selected tenants
                if (selectedTenants && selectedTenants.length > 0) {
                    selectedTenants.forEach(st => {
                        const tenantId = st.id || st;
                        selectedTenantsEdit.add(tenantId);
                        console.log('✅ Added to selection:', tenantId);
                    });
                }
                
                console.log('🟢 Rendering options...');
                renderTenantOptionsEdit();
                updateSelectedDisplayEdit();
                updateSelectedTagsEdit();
                console.log('🟢 All done!');
                
            } catch (error) {
                console.error('❌ Error loading related tenants:', error);
                document.getElementById('tenantOptionsEdit').innerHTML = 
                    '<div style="padding: 20px; text-align: center; color: var(--destructive);">خطأ في التحميل</div>';
            }
        }

        function renderTenantOptionsEdit() {
            console.log('🔵 renderTenantOptionsEdit called');
            const container = document.getElementById('tenantOptionsEdit');
            console.log('Container:', container);
            
            if (!allTenantsForSelection || allTenantsForSelection.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--muted-foreground);">-- لا يوجد عملاء آخرين --</div>';
                console.log('⚠️ No tenants to display');
                return;
            }
            
            container.innerHTML = '';
            console.log(`✅ Rendering ${allTenantsForSelection.length} options`);
            
            allTenantsForSelection.forEach(tenant => {
                const option = document.createElement('div');
                option.className = 'multi-select-option';
                option.dataset.tenantId = tenant.id;
                option.dataset.tenantName = tenant.name.toLowerCase();
                option.dataset.tenantSubdomain = tenant.subdomain.toLowerCase();
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `tenant-edit-${tenant.id}`;
                checkbox.checked = selectedTenantsEdit.has(tenant.id);
                checkbox.onchange = () => toggleTenantSelectionEdit(tenant.id);
                
                const label = document.createElement('label');
                label.htmlFor = `tenant-edit-${tenant.id}`;
                label.textContent = `${tenant.name} (${tenant.subdomain})`;
                label.style.cursor = 'pointer';
                label.style.margin = '0';
                
                option.appendChild(checkbox);
                option.appendChild(label);
                container.appendChild(option);
            });
        }

        function toggleEditMultiSelectDropdown() {
            const dropdown = document.getElementById('multiSelectDropdownEdit');
            const header = document.querySelector('.multi-select-header-edit');
            
            dropdown.classList.toggle('show');
            header.classList.toggle('active');
        }

        function toggleTenantSelectionEdit(id) {
            if (selectedTenantsEdit.has(id)) {
                selectedTenantsEdit.delete(id);
            } else {
                selectedTenantsEdit.add(id);
            }
            
            updateSelectedDisplayEdit();
            updateSelectedTagsEdit();
        }

        function removeTenantEdit(id) {
            selectedTenantsEdit.delete(id);
            
            // Uncheck the checkbox
            const checkbox = document.getElementById(`tenant-edit-${id}`);
            if (checkbox) checkbox.checked = false;
            
            updateSelectedDisplayEdit();
            updateSelectedTagsEdit();
        }

        function updateSelectedDisplayEdit() {
            const display = document.getElementById('selectedTenantsDisplayEdit');
            
            if (selectedTenantsEdit.size === 0) {
                display.textContent = '-- اختر العملاء --';
                display.style.color = 'var(--muted-foreground)';
            } else {
                display.textContent = `تم اختيار ${selectedTenantsEdit.size} عميل`;
                display.style.color = 'var(--foreground)';
            }
        }

        function updateSelectedTagsEdit() {
            const container = document.getElementById('selectedTenantsTagsEdit');
            container.innerHTML = '';
            
            if (selectedTenantsEdit.size === 0) return;
            
            selectedTenantsEdit.forEach(tenantId => {
                const tenant = allTenantsForSelection.find(t => t.id === tenantId);
                if (!tenant) return;
                
                const tag = document.createElement('div');
                tag.className = 'tenant-tag';
                tag.innerHTML = `
                    <span>${tenant.name}</span>
                    <span class="remove-tag" onclick="removeTenantEdit('${tenant.id}')">×</span>
                `;
                container.appendChild(tag);
            });
        }

        function filterTenantsEdit() {
            const searchTerm = document.getElementById('tenantSearchInputEdit').value.toLowerCase();
            const options = document.querySelectorAll('#tenantOptionsEdit .multi-select-option');
            
            options.forEach(option => {
                const name = option.dataset.tenantName || '';
                const subdomain = option.dataset.tenantSubdomain || '';
                
                if (name.includes(searchTerm) || subdomain.includes(searchTerm)) {
                    option.style.display = 'flex';
                } else {
                    option.style.display = 'none';
                }
            });
        }

        async function loadEditModules(tenantId) {
            const modulesGrid = document.getElementById('modulesGrid');
            modulesGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #6c757d;">جاري تحميل الموديولات...</div>';

            try {
                const response = await fetch(`/api/tenants/${tenantId}/modules/`, {
                    credentials: 'include'
                });
                const modules = await response.json();
                
                // Store modules for this tenant
                tenantModules[tenantId] = modules;
                
                // Display modules as checkboxes
                modulesGrid.innerHTML = modules.map(module => `
                    <div class="module-item ${module.is_enabled ? 'enabled' : ''}" onclick="toggleModule('${module.id}')">
                        <input 
                            type="checkbox" 
                            class="module-checkbox" 
                            id="module-${module.id}" 
                            data-module-id="${module.id}"
                            data-module-key="${module.module_key}"
                            ${module.is_enabled ? 'checked' : ''}
                            onclick="event.stopPropagation();">
                        <label class="module-label" for="module-${module.id}">
                            ${module.module_name}
                        </label>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading modules for edit:', error);
                modulesGrid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: #dc3545;">حدث خطأ في تحميل الموديولات</div>';
            }
        }

        function toggleModule(moduleId) {
            const checkbox = document.getElementById(`module-${moduleId}`);
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                checkbox.dispatchEvent(new Event('change'));
                
                // Update visual state
                const moduleItem = checkbox.closest('.module-item');
                if (checkbox.checked) {
                    moduleItem.classList.add('enabled');
                } else {
                    moduleItem.classList.remove('enabled');
                }
            }
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
        }

        async function updateTenant(event) {
            event.preventDefault();

            const id = document.getElementById('editTenantId').value;
            
            const data = {
                name: document.getElementById('editName').value,
                custom_domain: document.getElementById('editCustomDomain').value || null,
                contact_email: document.getElementById('editEmail').value || null,
                contact_phone: document.getElementById('editPhone').value || null,
                primary_color: document.getElementById('editPrimaryColor').value,
                secondary_color: document.getElementById('editSecondaryColor').value,
                is_active: document.getElementById('editIsActive').value === 'true'
            };

            try {
                // Update tenant basic info
                const response = await fetch(`/api/tenants/${id}/`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    // Update modules
                    await updateTenantModules(id);
                    
                    showMessage('تم تحديث بيانات العميل والموديولات بنجاح', 'success');
                    closeEditModal();
                    refreshData();
                } else {
                    const error = await response.json();
                    showMessage('حدث خطأ: ' + JSON.stringify(error), 'error');
                }
            } catch (error) {
                console.error('Error updating tenant:', error);
                showMessage('حدث خطأ أثناء التحديث', 'error');
            }
        }

        async function updateTenantModules(tenantId) {
            const checkboxes = document.querySelectorAll('.module-checkbox');
            const updatePromises = [];

            for (const checkbox of checkboxes) {
                const moduleKey = checkbox.dataset.moduleKey;
                const isEnabled = checkbox.checked;
                
                // Send update request for each module
                const promise = fetch(`/api/tenants/${tenantId}/update_module/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        module_key: moduleKey,
                        is_enabled: isEnabled
                    })
                });
                
                updatePromises.push(promise);
            }

            try {
                await Promise.all(updatePromises);
                console.log('All modules updated successfully');
            } catch (error) {
                console.error('Error updating modules:', error);
                throw error;
            }
        }

        function deleteTenant(id, name) {
            currentDeleteId = id;
            document.getElementById('deleteTenantName').textContent = name;
            document.getElementById('deleteModal').classList.add('show');
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('show');
            currentDeleteId = null;
        }

        async function confirmDelete() {
            if (!currentDeleteId) return;

            try {
                const response = await fetch(`/api/tenants/${currentDeleteId}/`, {
                    method: 'DELETE',
                    credentials: 'include' // Important: send cookies
                });

                if (response.ok || response.status === 204) {
                    showMessage('تم حذف العميل بنجاح', 'success');
                    closeDeleteModal();
                    refreshData();
                } else {
                    const error = await response.json();
                    showMessage('حدث خطأ: ' + JSON.stringify(error), 'error');
                }
            } catch (error) {
                console.error('Error deleting tenant:', error);
                showMessage('حدث خطأ أثناء الحذف', 'error');
            }
        }

        function manageModules(id) {
            window.location.href = `/admin/hr_management/tenantmodule/?tenant__id__exact=${id}`;
        }

        function refreshData() {
            loadTenants();
            loadStatistics();
        }

        function showMessage(message, type) {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
            messageDiv.textContent = message;
            
            container.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Close modals on click outside
        document.getElementById('editModal').addEventListener('click', (e) => {
            if (e.target.id === 'editModal') closeEditModal();
        });
        document.getElementById('deleteModal').addEventListener('click', (e) => {
            if (e.target.id === 'deleteModal') closeDeleteModal();
        });
    </script>
</body>
</html>
