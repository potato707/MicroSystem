# 🔗 تكامل نظام الشيفتات مع الحضور والرواتب

## 📋 ملخص التحديثات

تم تحديث النظام القديم للحضور والانصراف ليتكامل مع نظام الشيفتات الأسبوعية الجديد (`WeeklyShiftSchedule`).

---

## ✅ ما تم تحديثه

### 1. **CheckInView** - تسجيل الحضور ✅

**الملف:** `hr_management/views.py`

**التحديثات:**
- ✅ يفحص جدول الشيفت الأسبوعي (`WeeklyShiftSchedule`) للموظف
- ✅ يحدد اليوم الحالي في الأسبوع (الأحد=0, الإثنين=1, ... السبت=6)
- ✅ يقارن وقت الحضور الفعلي بوقت البداية المتوقع
- ✅ **فترة سماح:** 15 دقيقة
  - إذا حضر الموظف خلال 15 دقيقة من وقت البداية → `present`
  - إذا حضر بعد 15 دقيقة → `late` + يحسب دقائق التأخير
- ✅ يحدث حالة الحضور في `EmployeeAttendance` تلقائياً

**مثال:**
```python
# الشيفت: 6:00 AM - 10:00 AM
# الحضور الساعة 6:10 AM → present ✅
# الحضور الساعة 6:20 AM → late (20 دقيقة تأخير) ⚠️
```

### 2. **CheckOutView** - تسجيل الانصراف ✅

**الملف:** `hr_management/views.py`

**التحديثات:**
- ✅ يفحص جدول الشيفت الأسبوعي
- ✅ يحسب إجمالي ساعات العمل الفعلية
- ✅ **خصم وقت الاستراحة:** ساعة واحدة للشيفتات أكثر من 6 ساعات
- ✅ **حساب الساعات الإضافية:**
  - فترة سماح: 30 دقيقة بعد وقت نهاية الشيفت
  - إذا انصرف بعد 30 دقيقة من وقت النهاية → يحسب overtime
- ✅ يرجع `total_hours` و `overtime_minutes` في الـ response

**مثال:**
```python
# الشيفت: 6:00 AM - 10:00 AM (4 ساعات)
# الانصراف الساعة 10:20 AM → لا توجد ساعات إضافية (ضمن فترة السماح)
# الانصراف الساعة 11:00 AM → 30 دقيقة ساعات إضافية ⏰
```

### 3. **WorkShift Signal** - حساب الرواتب ✅

**الملف:** `hr_management/signals.py`

**التحديثات:**
- ✅ يستخدم `WeeklyShiftSchedule` بدلاً من `employee.shift_start_time/end_time` القديم
- ✅ يحسب الراتب بناءً على:
  1. **الساعات المجدولة** من `WeeklyShiftSchedule`
  2. **الساعات الفعلية** من `WorkShift.check_in/check_out`
  3. **فترة السماح للتأخير:** 15 دقيقة
  4. **خصم وقت الاستراحة:** 60 دقيقة للشيفتات الطويلة
  5. **الساعات الإضافية:** معدل 1.5x أو `employee.overtime_rate`

**معادلة الراتب:**
```python
hourly_rate = (monthly_salary / 30) / 8  # راتب الساعة
base_pay = hourly_rate * actual_hours_worked
overtime_pay = overtime_rate * overtime_hours
total_salary = base_pay + overtime_pay
```

**الحد الأدنى:**
- إذا عمل الموظف أقل من ساعة → لا راتب ❌
- إذا عمل الموظف ساعة أو أكثر → يحسب الراتب حسب الساعات ✅

---

## 🔧 كيفية العمل

### السيناريو الكامل:

#### 1. **إنشاء جدول شيفت أسبوعي**
```bash
POST /hr/api/shift-schedules/bulk_create/
{
  "employee": "uuid-here",
  "schedules": [
    {"day_of_week": 6, "start_time": "06:00", "end_time": "10:00"}  # السبت
  ]
}
```

#### 2. **الموظف يسجل حضور**
```bash
POST /hr/attendance/checkin/{employee_id}/
Response:
{
  "status": "late",  # أو "present"
  "is_late": true,
  "late_minutes": 20,
  "expected_start": "06:00:00"
}
```

#### 3. **الموظف يسجل انصراف**
```bash
POST /hr/attendance/checkout/{employee_id}/
Response:
{
  "total_hours": 4.5,
  "overtime_minutes": 30
}
```

#### 4. **حساب الراتب تلقائياً**
عند حفظ `WorkShift.check_out`، يتم:
- ✅ حساب الساعات الفعلية
- ✅ خصم وقت الاستراحة
- ✅ حساب الساعات الإضافية
- ✅ إضافة الراتب إلى `MainWallet`

---

## 📊 الفرق بين النظام القديم والجديد

| الميزة | النظام القديم | النظام الجديد |
|--------|---------------|---------------|
| **تحديد الشيفت** | `employee.shift_start_time` ثابت | `WeeklyShiftSchedule` - شيفت مختلف لكل يوم |
| **كشف التأخير** | يدوي أو غير دقيق | تلقائي بناءً على الشيفت المحدد + 15 دقيقة سماح |
| **حساب الساعات الإضافية** | غير مدعوم | تلقائي: وقت النهاية + 30 دقيقة سماح |
| **حساب الراتب** | ثابت يومياً | يعتمد على الساعات الفعلية من الشيفت |
| **جداول مرنة** | ❌ | ✅ شيفت مختلف لكل يوم في الأسبوع |

---

## 🧮 أمثلة حسابية

### **مثال 1: حضور في الوقت**
- **الشيفت المحدد:** 6:00 AM - 10:00 AM (4 ساعات)
- **الحضور الفعلي:** 6:10 AM
- **الانصراف الفعلي:** 10:00 AM
- **النتيجة:**
  - Status: `present` ✅
  - Late minutes: 0
  - Total hours: 3.83 hours (خصم 10 دقائق لكن ضمن السماح)
  - Overtime: 0

### **مثال 2: تأخير + ساعات إضافية**
- **الشيفت المحدد:** 6:00 AM - 10:00 AM (4 ساعات)
- **الحضور الفعلي:** 6:20 AM
- **الانصراف الفعلي:** 11:00 AM
- **النتيجة:**
  - Status: `late` ⚠️
  - Late minutes: 20
  - Total hours: 4.67 hours
  - Overtime: 30 minutes (60 دقيقة بعد النهاية - 30 دقيقة سماح)

### **مثال 3: شيفت طويل**
- **الشيفت المحدد:** 8:00 AM - 6:00 PM (10 ساعات)
- **الحضور الفعلي:** 8:00 AM
- **الانصراف الفعلي:** 6:00 PM
- **النتيجة:**
  - Status: `present` ✅
  - Total hours: 9 hours (خصم ساعة استراحة)
  - Overtime: 0

---

## 🔍 Debugging

### **مشكلة: الموظف حاضر في الوقت لكن يظهر "late"**

**السبب المحتمل:**
1. لا يوجد `WeeklyShiftSchedule` محدد لهذا اليوم
2. اليوم في الأسبوع محسوب خطأ
3. وقت البداية في الـ schedule مختلف عن المتوقع

**الحل:**
```python
# افحص الشيفت
GET /hr/api/shift-schedules/employee_schedule/?employee_id={UUID}

# تأكد من:
# 1. day_of_week صحيح (السبت=6, الأحد=0)
# 2. start_time و end_time صحيحة
# 3. is_active = true
```

### **مشكلة: الراتب لا يُحسب**

**السبب المحتمل:**
1. `WorkShift.check_out` فارغ
2. لا يوجد `WeeklyShiftSchedule` لهذا اليوم
3. الموظف عمل أقل من ساعة

**الحل:**
```python
# افحص الـ WorkShift
GET /hr/api/work-shifts/?employee_id={UUID}&date={DATE}

# تأكد من:
# 1. check_in و check_out محددين
# 2. duration_minutes > 60
```

---

## 📝 ملاحظات مهمة

### ⚠️ **Backward Compatibility**
- النظام القديم لا يزال يعمل إذا لم يكن هناك `WeeklyShiftSchedule` محدد
- في حالة عدم وجود schedule، يتم:
  - الحضور: يسجل كـ `present` بدون فحص التأخير
  - الانصراف: يحسب الساعات بدون overtime
  - الراتب: يستخدم 8 ساعات كقيمة افتراضية

### ✅ **أفضل الممارسات**
1. **إنشاء جداول شيفت لجميع الموظفين** في `/dashboard/shifts/schedules`
2. **مراجعة الجداول أسبوعياً** للتأكد من صحتها
3. **استخدام الـ Live Monitor** في `/dashboard/shifts/monitor` لمتابعة الحضور
4. **التحقق من الرواتب** بعد كل دورة دفع

---

## 🚀 الخطوات التالية (اختيارية)

1. ✅ **تقارير متقدمة:** صفحة لعرض تقرير شهري بالساعات والتأخيرات
2. ✅ **إشعارات:** إرسال تنبيه عند التأخير المتكرر
3. ✅ **تصدير Excel:** تصدير بيانات الحضور والرواتب
4. ✅ **Dashboard للموظف:** السماح للموظف برؤية شيفته وساعاته

---

## 📞 Support

إذا واجهت أي مشكلة:
1. تحقق من الـ Django logs: `python manage.py runserver`
2. تحقق من الـ database: `WeeklyShiftSchedule`, `WorkShift`, `EmployeeAttendance`
3. راجع الـ signals في `hr_management/signals.py`

---

**تاريخ التحديث:** أكتوبر 2025  
**الإصدار:** 2.0
